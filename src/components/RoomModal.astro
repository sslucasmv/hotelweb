---
import { Icon } from 'astro-icon/components';
---


<div id="room-modal" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-sm items-center justify-center p-4">
<div class="bg-white rounded-3xl max-w-5xl w-full overflow-hidden relative shadow-2xl flex flex-col md:flex-row h-[90vh] md:h-[550px]">
    
    <button id="close-modal" class="absolute top-4 right-4 z-[110] bg-white/20 hover:bg-white p-2 rounded-full transition-all text-slate-800 shadow-lg border border-white/40">
     <Icon name="material-symbols:close" />
    </button>

    <div class="w-full md:w-2/3 bg-slate-100 relative overflow-hidden group">
      <div id="modal-img-container" class="flex h-full transition-transform duration-500 ease-in-out">
        </div>
      
      <button id="prev-btn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white p-3 rounded-full transition-all shadow-md active:scale-90"> 
        <Icon name="material-symbols:chevron-left" />
      </button>
      <button id="next-btn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white p-3 rounded-full transition-all shadow-md active:scale-90"> 
           <Icon name="material-symbols:chevron-right" />
      </button>
    </div>

    <div class="w-full md:w-1/3 p-10 flex flex-col bg-white">
      <h2 id="modal-title" class="text-3xl font-black text-slate-800 mb-4 leading-tight"></h2>
      <p id="modal-description" class="text-slate-500 text-sm leading-relaxed mb-8"></p>
      
      <div class="mt-auto">
        <a id="whatsapp-link" href="#" target="_blank" class="block w-full bg-blue-ocean text-white text-center py-4 rounded-2xl font-bold shadow-xl shadow-blue-ocean/20 hover:brightness-110 transition-all hover:-translate-y-1 active:scale-95">
          Reservar Ahora
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  function initModal() {
    let fotos = [];
    let index = 0;
    const modal = document.getElementById('room-modal');
    const container = document.getElementById('modal-img-container');

    if (!modal || !container) return;

    function updateSlider() {
      container.style.transform = `translateX(-${index * 100}%)`;
    }

function openModal(e) {
      const btn = e.currentTarget;
      fotos = JSON.parse(btn.dataset.fotos || '[]');
      index = 0;

      document.getElementById('modal-title').innerText = btn.dataset.titulo || '';
      document.getElementById('modal-description').innerText = btn.dataset.desc || '';
      
      // INYECCIÓN CORREGIDA:
      // Envolvemos cada imagen en un div que fuerza el alto al 100% del contenedor
      // y usamos object-cover para que la foto vertical se recorte sola.
      container.innerHTML = fotos.map(f => 
        `<div class="min-w-full h-full overflow-hidden">
          <img src="${f}" class="w-full h-full object-cover pointer-events-none">
        </div>`
      ).join('');

      // WhatsApp Link Dinámico
      const waLink = document.getElementById('whatsapp-link');
      const msg = encodeURIComponent(`¡Hola! Quisiera consultar disponibilidad para la ${btn.dataset.titulo}.`);
      waLink.href = `https://wa.me/5491112345678?text=${msg}`; 

      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      updateSlider();
    }

    function closeModal() {
      modal.style.display = 'none';
      document.body.style.overflow = '';
    }

    // Bindings
    document.querySelectorAll('.btn-open-modal').forEach(b => b.addEventListener('click', openModal));
    document.getElementById('close-modal')?.addEventListener('click', closeModal);
    document.getElementById('next-btn')?.addEventListener('click', () => { index = (index + 1) % fotos.length; updateSlider(); });
    document.getElementById('prev-btn')?.addEventListener('click', () => { index = (index - 1 + fotos.length) % fotos.length; updateSlider(); });
    
    // Cerrar al clickear afuera
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    // Esc Key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });
  }

  // Ejecutar para Astro
  initModal();
  document.addEventListener('astro:after-swap', initModal);
  document.addEventListener('astro:page-load', initModal);
</script>