---
import { Icon } from 'astro-icon/components';

// Cargamos las imágenes en el servidor para que Astro sepa que existen
const imagenesLocales = import.meta.glob<{ default: ImageMetadata }>('../assets/images/habitaciones/*.{jpeg,jpg,JPG,png,webp}');
---

<div id="room-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 md:p-10 transition-opacity duration-300">
  <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" id="modal-close-overlay"></div>

  <div class="bg-white w-full max-w-7xl h-full max-h-[80vh] md:max-h-[75vh] lg:max-h-[85vh] rounded-2xl overflow-hidden shadow-2xl flex flex-col relative z-10">
    
    <button id="close-modal" class="absolute top-4 right-4 z-50 bg-white/40 hover:bg-white/60 text-slate-800 p-2 rounded-full backdrop-blur-sm transition-all shadow-md">
      <Icon name="material-symbols:close" class="w-6 h-6" />
    </button>

    <div class="flex flex-col md:flex-row flex-grow min-h-0">
      <div class="w-full md:w-2/3 lg:w-[70%] bg-slate-100 relative group flex-shrink-0 min-h-[350px] md:min-h-full">
        <div id="main-image-container" class="relative w-full h-full flex items-center justify-center overflow-hidden bg-slate-200">
           </div>
        
        <button id="prev-photo" class="absolute left-4 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white p-3 rounded-full hidden transition-all z-20">
          <Icon name="material-symbols:chevron-left" class="w-7 h-7" />
        </button>
        <button id="next-photo" class="absolute right-4 top-1/2 -translate-y-1/2 bg-black/40 hover:bg-black/60 text-white p-3 rounded-full hidden transition-all z-20">
          <Icon name="material-symbols:chevron-right" class="w-7 h-7" />
        </button>
      </div>

      <div class="w-full md:w-1/3 lg:w-[30%] p-8 flex flex-col min-h-0 bg-white">
        <div class="overflow-y-auto flex-grow pr-2 mb-6 scrollbar-thin">
          <h2 id="modal-title" class="text-3xl font-bold text-slate-800 mb-5 tracking-tight leading-tight"></h2>
          <div id="modal-desc" class="text-slate-600 leading-relaxed text-sm md:text-base"></div>
        </div>
        
        <div class="mt-auto pt-4 border-t border-slate-100 flex-shrink-0">
           <a href="https://wa.me/tu-numero" target="_blank" class="w-full bg-blue-ocean text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700 transition-colors shadow-lg">
              Consultar disponibilidad
              <Icon name="material-symbols:calendar-month" class="w-5 h-5" />
           </a>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  // Esta función contendrá toda la lógica para que se reinicie en cada navegación
  function setupModal() {
    const images = import.meta.glob('/src/assets/images/habitaciones/*.{jpeg,jpg,JPG,png,webp}', { eager: true });
    
    const modal = document.getElementById('room-modal');
    const overlay = document.getElementById('modal-close-overlay');
    const closeBtn = document.getElementById('close-modal');
    const mainImageContainer = document.getElementById('main-image-container');
    const titleEl = document.getElementById('modal-title');
    const descEl = document.getElementById('modal-desc');
    const prevBtn = document.getElementById('prev-photo');
    const nextBtn = document.getElementById('next-photo');

    let currentPhotos = [];
    let currentIndex = 0;

    function updateImage() {
      if (!mainImageContainer || currentPhotos.length === 0) return;
      const photoName = currentPhotos[currentIndex];
      const fullPath = `/src/assets/images/habitaciones/${photoName}`;
      const optimizedImg = images[fullPath];

      if (optimizedImg) {
        // @ts-ignore
        const src = optimizedImg.default.src;
        mainImageContainer.innerHTML = `
          <img 
            src="${src}" 
            class="absolute inset-0 w-full h-full object-cover fade-in" 
            alt="Habitación" 
            loading="lazy"
          />`;
      }

      if (currentPhotos.length > 1) {
        prevBtn?.classList.remove('hidden');
        nextBtn?.classList.remove('hidden');
      } else {
        prevBtn?.classList.add('hidden');
        nextBtn?.classList.add('hidden');
      }
    }

    function openModal(data) {
      if (!modal) return;
      currentPhotos = data.fotos || [];
      currentIndex = 0;
      if (titleEl) titleEl.innerText = data.titulo;
      if (descEl) descEl.innerText = data.desc;
      updateImage();
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      if (!modal) return;
      modal.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Delegación de eventos (limpia eventos previos si Astro re-renderiza)
    const handleOpenClick = (e) => {
      const target = e.target;
      const btn = target.closest('.btn-open-modal');
      if (btn) {
        const data = {
          titulo: btn.getAttribute('data-titulo'),
          desc: btn.getAttribute('data-desc'),
          fotos: JSON.parse(btn.getAttribute('data-fotos') || '[]')
        };
        openModal(data);
      }
    };

    document.addEventListener('click', handleOpenClick);

    nextBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      currentIndex = (currentIndex + 1) % currentPhotos.length;
      updateImage();
    });

    prevBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      currentIndex = (currentIndex - 1 + currentPhotos.length) % currentPhotos.length;
      updateImage();
    });

    [closeBtn, overlay].forEach(el => el?.addEventListener('click', closeModal));
    
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });
  }

  // AQUÍ ESTÁ LA MAGIA: 
  // Ejecuta la función la primera vez y cada vez que navegues entre páginas
  document.addEventListener('astro:page-load', setupModal);
</script>